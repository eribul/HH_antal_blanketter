{
    "collab_server" : "",
    "contents" : "\n\n\nis.inca <- function(){\n  unname(!(Sys.info()[\"user\"] == \"erikbulow\"))\n}\n\nif (!is.inca()) {\n  setwd(\"~/Documents/huvud_hals/atal_blanketter\")\n  rm(list = ls())\n  is.inca <- function(){\n    unname(!(Sys.info()[\"user\"] == \"erikbulow\"))\n  }\n  if (!file.exists(\"ov.rda\")) {\n    df <- read.csv2(\"cx2.txt\")\n    df_rec <- read.csv2(\"cx4.txt\")\n    save(df, file = \"ov.rda\")\n    save(df_rec, file = \"ov4.rda\")\n  } else {\n    load(\"ov.rda\")\n    load(\"ov4.rda\")\n  }\n  param <- list(\n      Länindelning = \"Sydöstra\",\n      Från = 2008,\n      Till = 2014,\n      Diagnos = \"Cervix\"\n  )\n}\n\n\n\n################################################################################\n#                                                                              #\n#           Gemensam bearbetningar för indikatorer (Blankett 1,2,3,5           #\n#                                                                              #\n################################################################################\n\nlibrary(Epi)\nlibrary(gdata)\nlibrary(reshape2)\nlibrary(jsonlite)\nlibrary(plyr)\nlibrary(dplyr)\n\ndata <- df\n\nnames(data) <- tolower(colnames(data))  # Gemener till alla variabelnamn\ndata$region <- trim(as.character(data$region))\ndata$a_diadat_ar <- substring(data$a_diadat,1,4)\n\nLänindelning <- param[[\"Länindelning\"]]\nif (Länindelning == \"Sydöstra\") {\n  data$a_lkf[nchar(data$a_lkf) == 5] <- paste0(\"0\", data$a_lkf)[nchar(data$a_lkf) == 5]\n  ##### Konvertering av de två länen i Uppsala/Örebro till Sydöstra ######\n  data$a_lkf <- as.character(data$a_lkf)\n  data$region <- as.character(data$region)\n  data$region[substr(as.character(data$a_lkf), 1, 2) %in% c(\"19\", \"04\")] <- \"Region Sydöstra\"\n  ########################################################################\n}\n\n########## Ersätt inrapporterade klinik/sjukhus om Hemsjukhus = \"Nej\" ###############\ndata$a_rappsjhemsj_beskrivning <- as.character(data$a_rappsjhemsj_beskrivning)\ndata$a_inrappsjh <- as.character(data$a_inrappsjh)\ndata$sjukhuskod <- as.character(data$sjukhuskod)\ndata$a_hemklinik <- as.character(data$a_hemklinik)\ndata$a_inrappklk <- as.character(data$a_inrappklk)\n\ndata$a_inrappsjh[data$a_rappsjhemsj_beskrivning == \"Nej\" & !is.na(data$sjukhuskod) ] <- data$sjukhuskod[data$a_rappsjhemsj_beskrivning == \"Nej\" & !is.na(data$sjukhuskod)]\ndata$a_inrappklk[data$a_rappsjhemsj_beskrivning == \"Nej\" & !is.na(data$a_hemklinik) ] <- data$a_hemklinik[data$a_rappsjhemsj_beskrivning == \"Nej\" & !is.na(data$a_hemklinik) ]\n####################################################################################\n\n\ndata$regionny[data$region == \"Region Norr\"] <- 1\ndata$regionny[data$region == \"Region Uppsala/Örebro\"] <- 2\ndata$regionny[data$region == \"Region Sthlm/Gotland\"] <- 3\ndata$regionny[data$region == \"Region Väst\"] <- 4\ndata$regionny[data$region == \"Region Sydöstra\"] <- 5\ndata$regionny[data$region == \"Region Syd\"] <- 6\n\ndata$region.f <- factor(data$regionny,exclude = NULL)\n\nregion_list <- list(\n  \"Norra\" = 1,\n  \"Uppsala/Örebro\" = 2,\n  \"Sthlm/Gotland\" = 3,\n  \"Västra\" = 4,\n  \"Sydöstra\" = 5,\n  \"Södra\" = 6\n)\nlevels(data$region.f) <- region_list\n\n\n\n################################################################################\n#                                                                              #\n#              Gemensam bearbetningar för indikatorer (Blankett 4              #\n#                                                                              #\n################################################################################\ndata_rec <- df_rec\nnames(data_rec) <- tolower(colnames(data_rec))  # Gemener till alla variabelnamn\ndata_rec$region <- trim(as.character(data_rec$region))\ndata_rec$a_diadat_ar <- substring(data_rec$a_diadat,1,4)\n\nLänindelning <- param[[\"Länindelning\"]]\nif (Länindelning == \"Sydöstra\") {\n  data_rec$a_lkf[nchar(data_rec$a_lkf) == 5] <- paste0(\"0\", data_rec$a_lkf)[nchar(data_rec$a_lkf)== 5]\n  ##### Konvertering av de två länen i Uppsala/Örebro till Sydöstra ######\n  data_rec$a_lkf <- as.character(data_rec$a_lkf)\n  data_rec$region <- as.character(data_rec$region)\n  data_rec$region[substr(as.character(data_rec$a_lkf), 1, 2) %in% c(\"19\", \"04\")] <- \"Region Sydöstra\"\n  ########################################################################\n}\n\n\n\ndata_rec$regionny[data_rec$region == \"Region Norr\"] <- 1\ndata_rec$regionny[data_rec$region == \"Region Uppsala/Örebro\"] <- 2\ndata_rec$regionny[data_rec$region == \"Region Sthlm/Gotland\"] <- 3\ndata_rec$regionny[data_rec$region == \"Region Väst\"] <- 4\ndata_rec$regionny[data_rec$region == \"Region Sydöstra\"] <- 5\ndata_rec$regionny[data_rec$region == \"Region Syd\"] <- 6\n\ndata_rec$region.f <- factor(data_rec$regionny,exclude = NULL)\nregion_list <- list(\n  \"Norra\" = 1,\n  \"Uppsala/Örebro\" = 2,\n  \"Sthlm/Gotland\" = 3,\n  \"Västra\" = 4,\n  \"Sydöstra\" = 5,\n  \"Södra\" = 6\n)\nlevels(data_rec$region.f) <- region_list\n\n\n\n\n######## PARAMETRAR ########\nif (is.inca()) {\n  Från <- as.numeric(param[[\"Från\"]])\n  Till <- as.numeric(param[[\"Till\"]])\n  Diagnos <- param[[\"Diagnos\"]]\n} else {\n  ## Lokalt\n  Från <- 2008\n  Till <- 2014\n  Diagnos <- \"Cervix\"\n}\n############################\n\n\n# Subsetta diagnoser\ndata <- subset(data, a_icd_gruppnamn %in% Diagnos)\ndata_rec <- subset(data_rec, a_icd_gruppnamn %in% Diagnos)\nDiagnos <- paste(Diagnos, collapse = \",\")\n\n\n\n\n\n\n\n\n\n############################ ############################ #############################\n#                                                                                     #\n#                                                                                     #\n#                           Indikator 1: Antal blankett 1                             #\n#                                                                                     #\n#                                                                                     #\n############################ ############################ #############################\n\n# Subsettar enbart de med inrapporterat datum\ndata1 <- data %>%\n  filter(!is.na(a_inrappdatum) & a_inrappdatum != \"\" & a_diadat_ar != \"\" & a_diadat_ar >= 2011)\n\n\n# Lägga till klinik om användaren loggar in på en sådan med data\nunit <- nchar(data1$userunitcode[1])\nklinik <- data1[0, ]\n\nif (unit != 1 ) klinik <- subset(data1,(data1$userunitcode == data1$a_inrappklk &\n                                         data1$userparentunitcode == data1$a_inrappsjh))\nif (unit != 1 & nrow(klinik) > 0) hemregion <- sort(as.character(klinik$region.f),decreasing = TRUE)[1]\n\nif (unit != 1 & nrow(klinik) > 0) levels(data1$region.f) <- sub(hemregion, paste(hemregion,\"(exkl. din klinik)\"), levels(data1$region.f))\n\n\nif (unit != 1 & nrow(klinik) > 0) data1 <- subset(data1,(!(data1$userunitcode == data1$a_inrappklk &\n                                                            data1$userparentunitcode == data1$a_inrappsjh) | (is.na(data1$a_inrappklk) | is.na(data1$a_inrappsjh))))\n\nif (unit != 1 & nrow(klinik) > 0) klinik$region.f <-\"Din klinik\"\nif (unit != 1 & nrow(klinik) > 0) data1 <- rbind(data1,klinik)\n\n\n\ndata1 <- data1 %>%\n  select(a_diadat_ar, region.f)\n\n# Skapa kategorivariabel i.e. år till JS format\nkat1 <- levels(as.factor(data1$a_diadat_ar))\nkat1 <- paste0(\"var kat1 = ['\", paste(kat1,collapse = \"','\"), \"'];\" )\n\n# Skapa regionsvariabel med värden till JS format\nif (nrow(data1) != 0) {\ndata1 <- dcast(data1, region.f ~ a_diadat_ar, value.var = \"region.f\", fun.aggregate = length)\ndata1$data <- do.call(paste, data1[2:ncol(data1)])\ndata1$data <- gsub(\" \", \",\", data1$data)\ndata1$data <- paste0(\"[\",data1$data,\"]\")\ndata1 <- data1[c(\"region.f\", \"data\")]\nnames(data1) <- c(\"name\", \"data\")\nser1 <- paste(\"var\",\"ser1\",\"=\",toJSON(data1), \";\")\nser1 <- gsub('\\\\\"\\\\[', '[', ser1  )\nser1 <- gsub('\\\\]\\\\\"', ']', ser1  )\n}\nif (nrow(data1) == 0) {\n  ser1 <- \"var ser1 = [] ;\"\n}\n# Skapa titel\ntitel1 <- paste(\"Antal anmälningsblanketter\")\ntitel1 <- paste(\"var titel1 =\", \"'\",titel1,\"'\", \";\")\nsubtitel1 <- paste(\"(Urval: \",Diagnos,\")\", sep = \"\")\nsubtitel1 <- paste(\"var subtitel1 =\", \"'\",subtitel1,\"'\", \";\")\n\n\n# Namn på axlar\nyaxis1 <- paste0(\"var yaxis1 = \",\"'\" ,\"Antal blanketter\", \"'\" ,\";\")\nxaxis1 <- paste0(\"var xaxis1 = \",\"'\", \"Diagnosår\",\"'\" ,\";\")\n\n\n\n\n\n\n\n\n\n############################ ############################ #############################\n#                                                                                     #\n#                                                                                     #\n#                           Indikator 2: Antal blankett 2                             #\n#                                                                                     #\n#                                                                                     #\n############################ ############################ #############################\n\n# Subsettar enbart de med inrapporterat datum\ndata2 <- data %>%\n  filter(!is.na(k_inrappdat) & k_inrappdat != \"\" & a_diadat_ar != \"\" & a_diadat_ar >= 2011)\n\n# Lägga till klinik om användaren loggar in på en sådan med data\nunit <- nchar(data2$userunitcode[1])\nklinik <- data2[0, ]\n\n\nif (unit != 1 ) klinik <- subset(data2,(data2$userunitcode == data2$k_inrappenhklkkod &\n                                         data2$userparentunitcode == data2$k_inrappenhsjhkod))\nif (unit != 1 & nrow(klinik) > 0) hemregion <- sort(as.character(klinik$region.f), decreasing = TRUE)[1]\n\nif (unit != 1 & nrow(klinik) > 0) levels(data2$region.f) <- sub(hemregion, paste(hemregion,\"(exkl. din klinik)\"), levels(data2$region.f))\n\n\nif (unit != 1 & nrow(klinik) > 0) data2 <- subset(data2,(!(data2$userunitcode == data2$k_inrappenhklkkod &\n                                         data2$userparentunitcode == data2$k_inrappenhsjhkod) | (is.na(data2$k_inrappenhklkkod) | is.na(data2$k_inrappenhsjhkod))))\n\nif (unit != 1 & nrow(klinik) > 0) klinik$region.f <- \"Din klinik\"\nif (unit != 1 & nrow(klinik) > 0) data2 <- rbind(data2,klinik)\n\ndata2 <- data2 %>%\n  select(a_diadat_ar, region.f)\n\n# Skapa kategorivariabel i.e. år till JS format\nkat2 <- levels(as.factor(data2$a_diadat_ar))\nkat2 <- paste0(\"var kat2 = ['\", paste(kat2,collapse = \"','\"), \"'];\" )\n\n# Skapa regionsvariabel med värden till JS format\nif (nrow(data2) != 0){\ndata2 <- dcast(data2, region.f ~ a_diadat_ar, value.var = \"region.f\", fun.aggregate = length)\ndata2$data <- do.call(paste, data2[2:ncol(data2)])\ndata2$data <- gsub(\" \", \",\", data2$data)\ndata2$data <- paste0(\"[\",data2$data,\"]\")\ndata2 <- data2[c(\"region.f\", \"data\")]\nnames(data2) <- c(\"name\", \"data\")\nser2 <- paste(\"var\",\"ser2\",\"=\",toJSON(data2), \";\")\nser2 <- gsub('\\\\\"\\\\[', '[', ser2  )\nser2 <- gsub('\\\\]\\\\\"', ']', ser2  )\n}\nif (nrow(data2) == 0) {\n  ser2 <- \"var ser2 = [] ;\"\n}\n# Skapa titel\ntitel2 <- paste(\"Antal kirurgiblanketter\")\ntitel2 <- paste(\"var titel2 =\", \"'\",titel2,\"'\", \";\")\nsubtitel2 <- paste(\"(Urval: \",Diagnos,\")\", sep = \"\")\nsubtitel2 <- paste(\"var subtitel2 =\", \"'\",subtitel2,\"'\", \";\")\n\n\n# Namn på axlar\nyaxis2 <- paste0(\"var yaxis2 = \",\"'\" ,\"Antal blanketter\", \"'\" ,\";\")\nxaxis2 <- paste0(\"var xaxis2 = \",\"'\", \"Diagnosår\",\"'\" ,\";\")\n\n\n\n\n\n\n############################ ############################ #############################\n#                                                                                     #\n#                                                                                     #\n#                           Indikator 3: Antal blankett 3                             #\n#                                                                                     #\n#                                                                                     #\n############################ ############################ #############################\n\n\n\n# Subsettar enbart de med inrapporterat datum\ndata3 <- data %>%\n  filter(!is.na(p_inrappdat) & p_inrappdat != \"\" & a_diadat_ar != \"\" & a_diadat_ar >= 2011)\n\n\n# Lägga till klinik om användaren loggar in på en sådan med data\nunit <- nchar(data3$userunitcode[1])\nklinik <- data3[0, ]\n\nif (unit != 1 ) klinik <- subset(data3,(data3$userunitcode == data3$p_inrappenhklkkod &\n                                         data3$userparentunitcode == data3$p_inrappenhsjhkod))\n\nif (unit != 1 & nrow(klinik) > 0) hemregion <- sort(as.character(klinik$region.f), decreasing = TRUE)[1]\n\nif (unit != 1 & nrow(klinik) > 0) levels(data3$region.f) <- sub(hemregion, paste(hemregion,\"(exkl. din klinik)\"), levels(data3$region.f))\n\n\nif (unit != 1 & nrow(klinik) > 0) data3 <- subset(data3,(!(data3$userunitcode == data3$p_inrappenhklkkod &\n                                                            data3$userparentunitcode == data3$p_inrappenhsjhkod) | (is.na(data3$p_inrappenhklkkod) | is.na(data3$p_inrappenhsjhkod))))\n\nif (unit != 1 & nrow(klinik) > 0) klinik$region.f <-\"Din klinik\"\nif (unit != 1 & nrow(klinik) > 0) data3 <-rbind(data3,klinik)\n\ndata3 <- data3 %>%\n  select(a_diadat_ar, region.f)\n\n\n\n# Skapa kategorivariabel i.e. år till JS format\nkat3 <- levels(as.factor(data3$a_diadat_ar))\nkat3 <- paste0(\"var kat3 = ['\", paste(kat3,collapse = \"','\"), \"'];\" )\n\n# Skapa regionsvariabel med värden till JS format\nif (nrow(data3) != 0) {\ndata3 <- dcast(data3, region.f ~ a_diadat_ar, value.var = \"region.f\", fun.aggregate = length)\ndata3$data <- do.call(paste, data3[2:ncol(data3)])\ndata3$data <- gsub(\" \", \",\", data3$data)\ndata3$data <- paste0(\"[\",data3$data,\"]\")\ndata3 <- data3[c(\"region.f\", \"data\")]\nnames(data3) <- c(\"name\", \"data\")\nser3 <- paste(\"var\",\"ser3\",\"=\",toJSON(data3), \";\")\nser3 <- gsub('\\\\\"\\\\[', '[', ser3  )\nser3 <- gsub('\\\\]\\\\\"', ']', ser3  )\n}\nif (nrow(data3) == 0) {\n  ser3 <- \"var ser3 = [] ;\"\n}\n# Skapa titel\ntitel3 <- paste(\"Antal primärbehandlingsblanketter\")\ntitel3 <- paste(\"var titel3 =\", \"'\",titel3,\"'\", \";\")\nsubtitel3 <- paste(\"(Urval: \",Diagnos,\")\", sep = \"\")\nsubtitel3 <- paste(\"var subtitel3 =\", \"'\",subtitel3,\"'\", \";\")\n\n\n# Namn på axlar\nyaxis3 <- paste0(\"var yaxis3 = \",\"'\" ,\"Antal blanketter\", \"'\" ,\";\")\nxaxis3 <- paste0(\"var xaxis3 = \",\"'\", \"Diagnosår\",\"'\" ,\";\")\n\n\n\n\n\n\n\n############################ ############################ #############################\n#                                                                                     #\n#                                                                                     #\n#                           Indikator 4: Antal blankett 4                             #\n#                           (O.B.S. här använder vi en annan DF)                      #\n#                                                                                     #\n############################ ############################ #############################\n\n\n\n# Subsettar enbart de med inrapporterat datum, då denna data tages från annan DF så behöver vi även sortera diagnosår\ndata4 <- data_rec %>%\n  filter(!is.na(r_inrappdat) & a_diadat_ar >= Från  & a_diadat_ar <= Till & r_inrappdat != \"\" & a_diadat_ar != \"\" & a_diadat_ar >= 2011)\n\n\n# Lägga till klinik om användaren loggar in på en sådan med data\nunit <- nchar(data4$userunitcode[1])\nklinik <- data4[0, ]\n\n\nif (unit != 1 ) klinik <- subset(data4,(data4$userunitcode==data4$r_inrappenhklkkod &\n                                         data4$userparentunitcode == data4$r_inrappenhsjhkod))\n\nif (unit != 1 & nrow(klinik) > 0) hemregion <- sort(as.character(klinik$region.f),decreasing=TRUE)[1]\n\nif (unit != 1 & nrow(klinik) > 0) levels(data4$region.f) <- sub(hemregion, paste(hemregion,\"(exkl. din klinik)\"), levels(data4$region.f))\n\n\nif (unit != 1 & nrow(klinik) > 0) data4<- subset(data4,(!(data4$userunitcode==data4$r_inrappenhklkkod &\n                                                            data4$userparentunitcode==data4$r_inrappenhsjhkod) | (is.na(data4$r_inrappenhklkkod) | is.na(data4$r_inrappenhsjhkod))))\n\nif (unit != 1 & nrow(klinik) > 0) klinik$region.f<-\"Din klinik\"\nif (unit != 1 & nrow(klinik) > 0) data4<-rbind(data4,klinik)\n\n\n\ndata4 <- data4 %>%\n  select(a_diadat_ar, region.f)\n\n\n\n# Skapa kategorivariabel i.e. år till JS format\nkat4 <- levels(as.factor(data4$a_diadat_ar))\nkat4 <- paste0(\"var kat4 = ['\", paste(kat4,collapse = \"','\"), \"'];\" )\n\n# Skapa regionsvariabel med värden till JS format\nif(nrow(data4) != 0){\ndata4 <- dcast(data4, region.f ~ a_diadat_ar, value.var = \"region.f\", fun.aggregate = length)\ndata4$data <- do.call(paste, data4[2:ncol(data4)])\ndata4$data <- gsub(\" \", \",\", data4$data)\ndata4$data <- paste0(\"[\",data4$data,\"]\")\ndata4 <- data4[c(\"region.f\", \"data\")]\nnames(data4) <- c(\"name\", \"data\")\nser4 <- paste(\"var\",\"ser4\",\"=\",toJSON(data4), \";\")\nser4 <- gsub('\\\\\"\\\\[', '[', ser4  )\nser4 <- gsub('\\\\]\\\\\"', ']', ser4  )\n}\nif(nrow(data4) == 0){\n  ser4 <- \"var ser4 = [] ;\"\n}\n# Skapa titel\ntitel4 <- paste(\"Antal recidivblanketter\")\ntitel4 <- paste(\"var titel4 =\", \"'\",titel4,\"'\", \";\")\nsubtitel4 <- paste(\"(Urval: \",Diagnos,\")\", sep =\"\")\nsubtitel4 <- paste(\"var subtitel4 =\", \"'\",subtitel4,\"'\", \";\")\n\n\n# Namn på axlar\nyaxis4 <- paste0(\"var yaxis4 = \",\"'\" ,\"Antal blanketter\", \"'\" ,\";\")\nxaxis4 <- paste0(\"var xaxis4 = \",\"'\", \"Diagnosår\",\"'\" ,\";\")\n\n\n\n\n\n\n############################ ############################ #############################\n#                                                                                     #\n#                                                                                     #\n#                           Indikator 5: Antal blankett 5                             #\n#                                                                                     #\n#                                                                                     #\n############################ ############################ #############################\n\n# Subsettar enbart de med inrapporterat datum\ndata5 <- data %>%\n  filter(!is.na(u_inrappdat) & u_inrappdat !=\"\" & a_diadat_ar != \"\" & a_diadat_ar >= 2011)\n\n# Lägga till klinik om användaren loggar in på en sådan med data\nunit <- nchar(data5$userunitcode[1])\nklinik <- data5[0, ]\n\nif (unit != 1 ) klinik<- subset(data5,(data5$userunitcode==data5$u_inrappenhklkkod &\n                                         data5$userparentunitcode==data5$u_inrappenhsjhkod))\n\nif (unit != 1 & nrow(klinik) > 0) hemregion <- sort(as.character(klinik$region.f),decreasing=TRUE)[1]\n\nif (unit != 1 & nrow(klinik) > 0) levels(data5$region.f) <- sub(hemregion, paste(hemregion,\"(exkl. din klinik)\"), levels(data5$region.f))\n\n\nif (unit != 1 & nrow(klinik) > 0) data5<- subset(data5,(!(data5$userunitcode==data5$u_inrappenhklkkod &\n                                                            data5$userparentunitcode==data5$u_inrappenhsjhkod) | (is.na(data5$u_inrappenhklkkod) | is.na(data5$u_inrappenhsjhkod))))\n\nif (unit != 1 & nrow(klinik) > 0) klinik$region.f<-\"Din klinik\"\nif (unit != 1 & nrow(klinik) > 0) data5<-rbind(data5,klinik)\n\n\ndata5 <- data5 %>%\n  select(a_diadat_ar, region.f)\n\n\n\n# Skapa kategorivariabel i.e. år till JS format\nkat5 <- levels(as.factor(data5$a_diadat_ar))\nkat5 <- paste0(\"var kat5 = ['\", paste(kat5,collapse = \"','\"), \"'];\" )\n\n# Skapa regionsvariabel med värden till JS format\nif(nrow(data5) != 0){\ndata5 <- dcast(data5, region.f ~ a_diadat_ar, value.var = \"region.f\", fun.aggregate = length)\ndata5$data <- do.call(paste, data5[2:ncol(data5)])\ndata5$data <- gsub(\" \", \",\", data5$data)\ndata5$data <- paste0(\"[\",data5$data,\"]\")\ndata5 <- data5[c(\"region.f\", \"data\")]\nnames(data5) <- c(\"name\", \"data\")\nser5 <- paste(\"var\",\"ser5\",\"=\",toJSON(data5), \";\")\nser5 <- gsub('\\\\\"\\\\[', '[', ser5  )\nser5 <- gsub('\\\\]\\\\\"', ']', ser5  )\n}\nif(nrow(data5) == 0){\n  ser5 <- \"var ser5 = [] ;\"\n}\n# Skapa titel\ntitel5 <- paste(\"Antal uppföljningsblanketter\")\ntitel5 <- paste(\"var titel5 =\", \"'\",titel5,\"'\", \";\")\nsubtitel5 <- paste(\"(Urval: \",Diagnos,\")\", sep =\"\")\nsubtitel5 <- paste(\"var subtitel5 =\", \"'\",subtitel5,\"'\", \";\")\n\n\n# Namn på axlar\nyaxis5 <- paste0(\"var yaxis5 = \",\"'\" ,\"Antal blanketter\", \"'\" ,\";\")\nxaxis5 <- paste0(\"var xaxis5 = \",\"'\", \"Diagnosår\",\"'\" ,\";\")\n\n\n\n\n\n\n\n\n############################ ############################ #############################\n#                                                                                     #\n#                                                                                     #\n#                           Indikator 6: Täckningsgrad blankett 2                     #\n#                                                                                     #\n#                                                                                     #\n############################ ############################ #############################\n\n\ndata6 <- subset(data, a_primop_beskrivning != \"Planeras ej\" &\n                  a_diadat_ar >= 2011, c(\"k_inrappdat\",\"a_diadat_ar\", \"region.f\")  )\n\n### Parametrar för återanvänding av skript ####\nrappdatum <- \"k_inrappdat\"\n\n\n###################### Bearbetning av data för att härleda täckningsgrad ######################\n# Skapa kategorivariabel i.e. år till JS format\nkat6 <- levels(as.factor(data6$a_diadat_ar))\nkat6 <- paste0(\"var kat6 = ['\", paste(kat6,collapse = \"','\"), \"'];\" )\n# Finns den aktuella blanketten eller inte\ndata6$rappdatum <- !is.na(as.Date(data6[[rappdatum]], format = \"%Y-%m-%d\"))\nif(nrow(data6) != 0){\ndata6 <- dcast(data6, region.f ~ a_diadat_ar, fun.aggregate = mean, value.var = \"rappdatum\", drop = FALSE)\n# Sätt eventuellt NAs på grund av 0 till 0 samt runda av täckningsgrader\ndata6[2:ncol(data6)] <- round(data6[2:ncol(data6)]*100,0)\ndata6[is.na(data6)] <- \"null\"\n\n# Konvertera till JSON format\ndata6$data <- do.call(paste, data6[2:ncol(data6)])\ndata6$data <- gsub(\" \", \",\", data6$data)\ndata6$data <- paste0(\"[\",data6$data,\"]\")\ndata6 <- data6[c(\"region.f\", \"data\")]\nnames(data6) <- c(\"name\", \"data\")\nser6 <- paste(\"var\",\"ser6\",\"=\",toJSON(data6), \";\")\nser6 <- gsub('\\\\\"\\\\[', '[', ser6  )\nser6 <- gsub('\\\\]\\\\\"', ']', ser6  )\n}\nif(nrow(data6) == 0){\n  ser6 <- \"var ser3 = [] ;\"\n}\n\n# Skapa titel\ntitel6 <- paste(\"Intern täckningsgrad (%) för kirurgiblanketten\")\ntitel6 <- paste(\"var titel6 =\", \"'\",titel6,\"'\", \";\")\nsubtitel6 <- paste(\"(Urval: \",Diagnos,\")\", sep =\"\")\nsubtitel6 <- paste(\"var subtitel6 =\", \"'\",subtitel6,\"'\", \";\")\n\n\nyaxis6 <- paste0(\"var yaxis6 = \",\"'\" ,\"Täckningsgrad (%)\", \"'\" ,\";\")\nxaxis6 <- paste0(\"var xaxis6 = \",\"'\", \"Diagnosår\",\"'\" ,\";\")\n\n\n\n\n\n\n############################ ############################ #############################\n#                                                                                     #\n#                                                                                     #\n#                           Indikator 7: Täckningsgrad blankett 3                     #\n#                                                                                     #\n#                                                                                     #\n############################ ############################ #############################\n\n\ndata7 <- subset(data, a_diadat_ar >= 2011, c(\"p_inrappdat\",\"a_diadat_ar\", \"region.f\")  )\n\n### Parametrar för återanvänding av skript ####\nrappdatum <- \"p_inrappdat\"\n\n\n###################### Bearbetning av data för att härleda täckningsgrad ######################\n# Skapa kategorivariabel i.e. år till JS format\nkat7 <- levels(as.factor(data7$a_diadat_ar))\nkat7 <- paste0(\"var kat7 = ['\", paste(kat7,collapse = \"','\"), \"'];\" )\n# Finns den aktuella blanketten eller inte\ndata7$rappdatum <- !is.na(as.Date(data7[[rappdatum]], format = \"%Y-%m-%d\"))\nif(nrow(data7) != 0){\ndata7 <- dcast(data7, region.f ~ a_diadat_ar, fun.aggregate = mean, value.var = \"rappdatum\", drop = FALSE)\n# Sätt eventuellt NAs på grund av 0 till 0 samt runda av täckningsgrader\ndata7[2:ncol(data7)] <- round(data7[2:ncol(data7)]*100,0)\ndata7[is.na(data7)] <- \"null\"\n\n# Konvertera till JSON format\ndata7$data <- do.call(paste, data7[2:ncol(data7)])\ndata7$data <- gsub(\" \", \",\", data7$data)\ndata7$data <- paste0(\"[\",data7$data,\"]\")\ndata7 <- data7[c(\"region.f\", \"data\")]\nnames(data7) <- c(\"name\", \"data\")\nser7 <- paste(\"var\",\"ser7\",\"=\",toJSON(data7), \";\")\nser7 <- gsub('\\\\\"\\\\[', '[', ser7  )\nser7 <- gsub('\\\\]\\\\\"', ']', ser7  )\n}\nif(nrow(data7) == 0){\n  ser7 <- \"var ser7 = [] ;\"\n}\n# Skapa titel\ntitel7 <- paste(\"Intern täckningsgrad (%) för primärbehandlingsblanketten\")\ntitel7 <- paste(\"var titel7 =\", \"'\",titel7,\"'\", \";\")\nsubtitel7 <- paste(\"(Urval: \",Diagnos,\")\", sep =\"\")\nsubtitel7 <- paste(\"var subtitel7 =\", \"'\",subtitel7,\"'\", \";\")\n\n\nyaxis7 <- paste0(\"var yaxis7 = \",\"'\" ,\"Täckningsgrad (%)\", \"'\" ,\";\")\nxaxis7 <- paste0(\"var xaxis7 = \",\"'\", \"Diagnosår\",\"'\" ,\";\")\n\n\n\n\n\n\n############################ ############################ #############################\n#                                                                                     #\n#                                                                                     #\n#                           Indikator 8: Täckningsgrad blankett 4                     #\n#                                                                                     #\n#                                                                                     #\n############################ ############################ #############################\n\n#  Då denna data tages från annan DF så behöver vi även sortera diagnosår\ndata8 <- subset(data_rec, !is.na(u_datreci)\n                & u_datreci != \"\" & a_diadat_ar >= Från &\n                  a_diadat_ar <= Till & a_diadat_ar >= 2011, c(\"r_inrappdat\",\"a_diadat_ar\", \"region.f\")  )\n\n### Parametrar för återanvänding av skript ####\nrappdatum <- \"r_inrappdat\"\n\n\n###################### Bearbetning av data för att härleda täckningsgrad ######################\n# Skapa kategorivariabel i.e. år till JS format\nkat8 <- levels(as.factor(data8$a_diadat_ar))\nkat8 <- paste0(\"var kat8 = ['\", paste(kat8,collapse = \"','\"), \"'];\" )\n# Finns den aktuella blanketten eller inte\ndata8$rappdatum <- !is.na(as.Date(data8[[rappdatum]], format = \"%Y-%m-%d\"))\nif(nrow(data8) != 0){\ndata8 <- dcast(data8, region.f ~ a_diadat_ar, fun.aggregate = mean, value.var = \"rappdatum\", drop = FALSE)\n# Sätt eventuellt NAs på grund av 0 till 0 samt runda av täckningsgrader\ndata8[2:ncol(data8)] <- round(data8[2:ncol(data8)]*100,0)\ndata8[is.na(data8)] <- \"null\"\n\n# Konvertera till JSON format\ndata8$data <- do.call(paste, data8[2:ncol(data8)])\ndata8$data <- gsub(\" \", \",\", data8$data)\ndata8$data <- paste0(\"[\",data8$data,\"]\")\ndata8 <- data8[c(\"region.f\", \"data\")]\nnames(data8) <- c(\"name\", \"data\")\nser8 <- paste(\"var\",\"ser8\",\"=\",toJSON(data8), \";\")\nser8 <- gsub('\\\\\"\\\\[', '[', ser8  )\nser8 <- gsub('\\\\]\\\\\"', ']', ser8  )\n}\nif(nrow(data8) == 0){\n  ser8 <- \"var ser8 = [] ;\"\n}\n# Skapa titel\ntitel8 <- paste(\"Intern täckningsgrad (%) för recidivblanketten\")\ntitel8 <- paste(\"var titel8 =\", \"'\",titel8,\"'\", \";\")\nsubtitel8 <- paste(\"(Urval: \",Diagnos,\")\", sep =\"\")\nsubtitel8 <- paste(\"var subtitel8 =\", \"'\",subtitel8,\"'\", \";\")\n\n\nyaxis8 <- paste0(\"var yaxis8 = \",\"'\" ,\"Täckningsgrad (%)\", \"'\" ,\";\")\nxaxis8 <- paste0(\"var xaxis8 = \",\"'\", \"Diagnosår\",\"'\" ,\";\")\n\n\n\n\n\n\n\n############################ ############################ #############################\n#                                                                                     #\n#                                                                                     #\n#                           Indikator 9: Täckningsgrad blankett 5                     #\n#                                                                                     #\n#                                                                                     #\n############################ ############################ #############################\n\n\ndata9 <- subset(data,  a_diadat_ar >= 2011, c(\"u_inrappdat\",\"a_diadat_ar\", \"region.f\")  )\n\n### Parametrar för återanvänding av skript ####\nrappdatum <- \"u_inrappdat\"\n\n\n###################### Bearbetning av data för att härleda täckningsgrad ######################\n# Skapa kategorivariabel i.e. år till JS format\nkat9 <- levels(as.factor(data9$a_diadat_ar))\nkat9 <- paste0(\"var kat9 = ['\", paste(kat9,collapse = \"','\"), \"'];\" )\n# Finns den aktuella blanketten eller inte\ndata9$rappdatum <- !is.na(as.Date(data9[[rappdatum]], format = \"%Y-%m-%d\"))\nif(nrow(data9) != 0){\ndata9 <- dcast(data9, region.f ~ a_diadat_ar, fun.aggregate = mean, value.var = \"rappdatum\", drop = FALSE)\n# Sätt eventuellt NAs på grund av 0 till 0 samt runda av täckningsgrader\ndata9[2:ncol(data9)] <- round(data9[2:ncol(data9)]*100,0)\ndata9[is.na(data9)] <- \"null\"\n\n# Konvertera till JSON format\ndata9$data <- do.call(paste, data9[2:ncol(data9)])\ndata9$data <- gsub(\" \", \",\", data9$data)\ndata9$data <- paste0(\"[\",data9$data,\"]\")\ndata9 <- data9[c(\"region.f\", \"data\")]\nnames(data9) <- c(\"name\", \"data\")\nser9 <- paste(\"var\",\"ser9\",\"=\",toJSON(data9), \";\")\nser9 <- gsub('\\\\\"\\\\[', '[', ser9  )\nser9 <- gsub('\\\\]\\\\\"', ']', ser9  )\n}\nif(nrow(data9) == 0){\n  ser9 <- \"var ser9 = [] ;\"\n}\n# Skapa titel\ntitel9 <- paste(\"Intern täckningsgrad (%) för uppföljningsblanketten\")\ntitel9 <- paste(\"var titel9 =\", \"'\",titel9,\"'\", \";\")\nsubtitel9 <- paste(\"(Urval: \",Diagnos,\")\", sep =\"\")\nsubtitel9 <- paste(\"var subtitel9 =\", \"'\",subtitel9,\"'\", \";\")\n\n\nyaxis9 <- paste0(\"var yaxis9 = \",\"'\" ,\"Täckningsgrad (%)\", \"'\" ,\";\")\nxaxis9 <- paste0(\"var xaxis9 = \",\"'\", \"Diagnosår\",\"'\" ,\";\")\n\n\n\n\n\n\n\n\n\n\n############################ ############################ #############################\n#                                                                                     #\n#                                                                                     #\n#                           Sammanslagning av del1 samt indikatorerna                 #\n#                                                                                     #\n#                                                                                     #\n############################ ############################ #############################\n\n# Ladda in del1\n#Lokalt\n#\nif(is.inca()) {\n  del1 <- scan(\"D:/R-Scripts/Väst/Oc5stafch/Rapportmallar/Cervix/Blanketter/del1_v2.txt\", what=\"\", sep=\"\\n\", quiet=TRUE,encoding=\"UTF-8\")\n} else {\n  del1 <- scan(\"del1_v2(offline).txt\", what=\"\", sep=\"\\n\", quiet=TRUE)\n}\n\n\n#Rapportinformation\nif(is.inca()) {\ninfo_register <- param[[\"info_register\"]]\ninfo_typ<- param[[\"info_typ\"]]\ninfo_info<- paste(\"Urval: \",Diagnos, sep =\"\")\n} else {\n  # Lokalt\n  info_register <- \"Registernamn\"\n  info_typ<- \"Rapportnamn\"\n  info_info<- paste(\"Urval: \",Diagnos, sep =\"\")\n}\n\n\n\ninfo_register <- paste0(\"document.getElementById('\",'register', \"').innerHTML='\",info_register,\"';\")\ninfo_typ <- paste0(\"document.getElementById('\",'typ av rapport', \"').innerHTML='\",info_typ,\"';\")\ninfo_info <- paste0(\"document.getElementById('\",'information', \"').innerHTML='\",info_info,\"';\")\n\noutfile <- file(\"./output.html\",\"w\",encoding=\"UTF-8\")\ncat(paste(\"\\n\",del1) ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",\"<script>\") ,file=outfile,append=TRUE)\n# Indikator 1\ncat(paste(\"\\n\",kat1) ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",ser1) ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",titel1) ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",subtitel1) ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",yaxis1) ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",xaxis1) ,file=outfile,append=TRUE)\n# Indikator 2\ncat(paste(\"\\n\",kat2) ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",ser2) ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",titel2) ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",subtitel2) ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",yaxis2) ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",xaxis2) ,file=outfile,append=TRUE)\n# Indikator 3\ncat(paste(\"\\n\",kat3) ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",ser3) ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",titel3) ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",subtitel3) ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",yaxis3) ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",xaxis3) ,file=outfile,append=TRUE)\n# Indikator 4\ncat(paste(\"\\n\",kat4) ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",ser4) ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",titel4) ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",subtitel4) ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",yaxis4) ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",xaxis4) ,file=outfile,append=TRUE)\n# Indikator 5\ncat(paste(\"\\n\",kat5) ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",ser5) ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",titel5) ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",subtitel5) ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",yaxis5) ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",xaxis5) ,file=outfile,append=TRUE)\n# Indikator 6\ncat(paste(\"\\n\",kat6) ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",ser6) ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",titel6) ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",subtitel6) ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",yaxis6) ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",xaxis6) ,file=outfile,append=TRUE)\n# Indikator 7\ncat(paste(\"\\n\",kat7) ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",ser7) ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",titel7) ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",subtitel7) ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",yaxis7) ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",xaxis7) ,file=outfile,append=TRUE)\n# Indikator 8\ncat(paste(\"\\n\",kat8) ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",ser8) ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",titel8) ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",subtitel8) ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",yaxis8) ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",xaxis8) ,file=outfile,append=TRUE)\n# Indikator 9\ncat(paste(\"\\n\",kat9) ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",ser9) ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",titel9) ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",subtitel9) ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",yaxis9) ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",xaxis9) ,file=outfile,append=TRUE)\n# Information i rapporten\ncat(paste(\"\\n\",info_register) ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",info_typ) ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",info_info) ,file=outfile,append=TRUE)\n# Ladda in funktionerna i skriptet\ncat(paste(\"\\n\",\"Stapeldiagram('container1', titel1, subtitel1, kat1, xaxis1, yaxis1, ser1);\n          \") ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",\"Stapeldiagram('container2', titel2, subtitel2, kat2, xaxis2, yaxis2, ser2);\n          \") ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",\"Stapeldiagram('container3', titel3, subtitel3, kat3, xaxis3, yaxis3, ser3);\n          \") ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",\"Stapeldiagram('container4', titel4, subtitel4, kat4, xaxis4, yaxis4, ser4);\n          \") ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",\"Stapeldiagram('container5', titel5, subtitel5, kat5, xaxis5, yaxis5, ser5);\n          \") ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",\"Tckdiagram('container6', titel6, subtitel6, kat6, xaxis6, yaxis6, ser6);\n          \") ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",\"Tckdiagram('container7', titel7, subtitel7, kat7, xaxis7, yaxis7, ser7);\n          \") ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",\"Tckdiagram('container8', titel8, subtitel8, kat8, xaxis8, yaxis8, ser8);\n          \") ,file=outfile,append=TRUE)\ncat(paste(\"\\n\",\"Tckdiagram('container9', titel9, subtitel9, kat9, xaxis9, yaxis9, ser9);\n          \") ,file=outfile,append=TRUE)\n\ncat(paste(\"\\n\",\"</script> </body> </html>\") ,file=outfile,append=TRUE)\nclose(outfile)\n",
    "created" : 1443700797429.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3088628842",
    "id" : "66CE55F4",
    "lastKnownWriteTime" : 1443701438,
    "path" : "~/Documents/huvud_hals/atal_blanketter/HH_blanketter.R",
    "project_path" : "HH_blanketter.R",
    "properties" : {
        "marks" : "<:68,28\n>:72,28"
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}